---
title: "Species Distribution Modeling in R"
author: "Sode A.I., Olajide A.Y., Nakhwala L., Opara A., Opoku M., Barasa C.W."
date: "2024-09-25"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This tutorial presents the workflow to build a Species Distribution Model (SDM) for *Bidens bipinnata*, the most abundant introduced species in Fogo Island in Cabo Verde (West Africa). 

We used **RMarkdown**, a simple formatting syntax for authoring HTML, PDF, and MS Word documents (see <http://rmarkdown.rstudio.com>). When you click the **Knit** button, a document will be generated that includes both content and the output of any embedded R code chunks within the document.


## Description of the data

Two types of data have been used to build the SDM for *B. bipinnata*. They are occurrence and environmental data. The **occurrence data** are constituted of geographical coordinates (longitude and latitude) of the species. These data are the subset of the Fogo species data we used in the second Module of our learning materials. The **environmental data** represent descriptors of the environment, and can include abiotic measurements such as temperature, precipitation, soil types, and land cover as well as biotic factors, such as the presence or absence of other species (like predators, competitors, or food sources). In this tutorial, we will focus on climate data and land cover.


## Data preparation

Loading required R packages

```{r, warning=FALSE}
library(terra)
library(geodata)
library(predicts)
```

### Occurrence data

First, we load the occurrence data of *B. bipinnata* observed in Fogo Island.

```{r}
obs_data <- read.csv(file = "occ_data/Bidens_bipinnata.csv")
head(obs_data)
```

After loading the data, we get an overview about it.
```{r}
summary(obs_data)
```

We drop NAs (if applicable) and make sure they went way before proceeding.

```{r}
obs_data <- obs_data[!is.na(obs_data$latitude), ]
summary(obs_data)
```

After removing NAs, we create a spatial vector object using the UTM coordinate system. This will help us later when we will need to overlay the species locations to the Fogo Island map.

```{r}
obs_points <- vect(obs_data, geom = c("longitude", "latitude"), 
                   crs = "+proj=utm +zone=26 +datum=WGS84 +units=m")
```

Then we project the vector data into long/lat to match it with the projection system of the Fogo Island map and bioclimatic layers. Note the climate data available in long/lat projection system will be downloaded in the next section.

```{r}
obs_points <- project(obs_points, "+proj=longlat +datum=WGS84")
```


Before proceeding, we should load the *Cabo Verde* map to visualize the observed species locations.

```{r}
# Load the map of Cabo Verde available as a shapefile.
map_fogo <- vect("gadm_cpv/fogo_island.shp")
```

We can then plot the observed data on the Fogo map.

```{r}
plot(map_fogo, axes = TRUE, col = "grey95")
points(x = geom(obs_points)[,"x"], 
       y = geom(obs_points)[,"y"], 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.8)
```

Though our focus in this module is not mapping, readers can add legend, title and any formatting elements relevant for the understanding of the species map.


### Environmental data

#### Bioclimatic data

After we processed the field data, we are going to download the climate data from the `Worldclim` website <https://www.worldclim.org/>. 


```{r, echo=FALSE}
# the path where the data should be stored
data_path <- "env_data/climate/wc2.1_country" 

# Check if the data already exists
if (!file.exists(data_path)) {
  # data does not exist, download it
  message("Climate data not found, downloading...")
  bioclim_data <- worldclim_country(country = "cabo verde", var = "bio",
                                   res = 0.5,
                                   path = "env_data/")
} else {
  # data exists, load it and proceed
  message("Climate data already exists, proceeding...")
  bioclim_data <- rast(list.files(data_path, pattern = ".tif", full.names = TRUE))
}
```

For simplicity purpose, we consider only three bioclimatic variables: annual temperature (bio1), temperature seasonality (bio4) and annual precipitation (bio12). However, we recommend learners of this module to explore variables selection techniques or use expert knowledge to come up with the potential environmental variables that could influence the distribution of the species of interest.

```{r}
bioclim_data <- c(bioclim_data$wc2.1_30s_bio_1, bioclim_data$wc2.1_30s_bio_12, bioclim_data$wc2.1_30s_bio_4)
```

We extract the bioclimatic variables using the geographic extent of Fogo Island. For other applications in which environmental variables are available beyond the study region, a study extent slightly larger than the study region is recommended. In this specific application, bioclimatic data are not available in the ocean around the Fogo Island. So there no need to include include in the analysis.

```{r}
bioclim_crop <- crop(bioclim_data, map_fogo)
bioclim_crop
```
We can see that the resolution of the bioclimatic data which is about 0.008333333 (approximately 1 kilometer around the Ecuador). 


#### Land cover data

Moreover, temperature and precipitation are well known to influence species distribution at large scale. However, at small scale like Fogo Island, other abiotic measurements like land cover may influence the species distribution. So, we have to load our **land cover** variable we created from the Module 2 to use it as a covariate in the species distribution model we are building for *B. bipinnata*.

```{r}
landcov <- rast("env_data/landcover_model2.tif")
plot(landcov)
```

Since all the environmental variables should have the same projection system and resolution, we project the land cover variable into long/lat system and crop it to Fogo Island extent. However, we should be aware that the good practice is to project vector layers instead of raster layers due to the lack of precision associated with raster projection. So we recommend projecting a raster layer in another reference system as a last resort. 

In the next chunk of code, we project the land cover map and extract its extent from Fogo Island map so that all environmental data have the same extent. Note that the `mask =TRUE` argument helps remove the Ocean around Fogo Island as there is no bioclimatic data available in that region. 

```{r}
landcov_ll <- project(landcov, "+proj=longlat +datum=WGS84", method ="near")
landcov_ll <- crop(landcov_ll, map_fogo, mask = TRUE)
landcov_ll
```

As we can see, the resolution of the land cover map is different from the one of bioclimatic data. So, we have to **resample** the land cover raster to the same resolution as the climatic data using the **near** interpolation method recommended for *categorical data*. Note that the resolution of bioclimatic data is lower than the original resolution of the land cover data. However, 30 arc-second resolution used in this study is the highest resolution available for bioclimatic data on the **Worldclim** website.

```{r}
landcov_res <- resample(landcov_ll, bioclim_crop$wc2.1_30s_bio_1, method = "near")
landcov_res  
```

After resampling the land cover map, we convert the raster into a factor before proceeding as we are dealing with a categorical variable.
```{r}
landcov_res <- as.factor(landcov_res)
```


Then, we merge the four environmental variables into a raster stack and visualize them on a quick map.

```{r}
bioclim_kept        <- c(bioclim_crop, landcov_res)
names(bioclim_kept) <- c("bio1", "bio4", "bio12", "landcover")
plot(bioclim_kept)
```


### Creating pseudo-absence points

In order to evaluate species distribution models with presence-only data, and really understand the factors influencing where *B.bipinnata*  occur, we need to include some absence or “background” points for coercing presence-only data for use with presence/absence approaches.

we then create a set of 200 background points (i.e. pseudo-absences) at random, and add these to our data. For a large study extent and environmental data, one can use 1,000 or even 5,000 pseudo-absence points. We encourage learners to play with different numbers of background points and compare the results.

```{r}
# Set seed for the random number generator to ensure results are similar across users.
set.seed(12354)

# Randomly sample points
background <- spatSample(x = bioclim_kept,
                         size = 200,     # 200 pseudo-absence points
                         values = FALSE, # don't need values
                         na.rm = TRUE,   # no sample from ocean
                         xy = TRUE)      # coordinates

# Look at the first rows
head(background)
```

After creating the background points, we can map them together with the observed species locations. On the resulting map, the background points are highlighted in grey color while the species occurrence locations are shown in *oliverdrab* color.

```{r}
# Plot the base map
plot(map_fogo,
     axes = TRUE, 
     col = "grey95")

# Add the background points
points(background,
       col = "grey30",
       pch = 1,
       cex = 0.75)

# Add the points for individual observations
points(x = geom(obs_points)[,"x"], 
       y = geom(obs_points)[,"y"], 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
```


Now, we can create a single dataset for both occurrence and pseudo-absences data. We create an additional column to indicate each type of points.

```{r}
# Presence-only data
presence <- as.data.frame(geom(obs_points)[, c("x", "y")])
colnames(presence) <- c("longitude", "latitude")
# Add column indicating presence
presence$pa <- 1

# Convert background data to a data frame
absence <- as.data.frame(background)
colnames(absence) <- c("longitude", "latitude")
# Add column indicating absence
absence$pa <- 0

# Join data into single data frame
all_points <- rbind(presence, absence)

# check the results
head(all_points)
```
### Adding climate data

We will use the `extract()` function, which takes geographic coordinates and raster layers as input, and extract values in the raster data for each of the geographic coordinates.

```{r}
bioclim_extract <- extract(x = bioclim_kept,
                           y = all_points[, c("longitude", "latitude")],
                           ID = FALSE) 
```


Now, we need to join the extracted data with points and drop out the longitude/latitude columns which are no longer relevant for the SDM implementation. 

```{r}
# Add the point and climate datasets together
points_climate <- cbind(all_points, bioclim_extract)

# Identify columns that are latitude & longitude
drop_cols <- which(colnames(points_climate) %in% c("longitude", "latitude"))
drop_cols 
```

```{r}
# Remove the geographic coordinates from the data frame
points_climate <- points_climate[, -drop_cols]
```

Note that, one can standardize numeric covariates to have the same scale, in case the model includes many covariates. We encourage learners to think about this aspect in their future projects. In the next section, we will generate the training and test data for our SDM.


### Training and testing data

After preparing our dataset for the model building, we are going to split it into training and testing samples. We will 80% of the data for training the model and 20% for testing it.

```{r}
# Create vector indicating fold
fold <- folds(x = points_climate,
              k = 5,
              by = points_climate$pa)
```

Take a look at each split
```{r}
table(fold)
```

We can use any observations in the fold 1 as test sample and the remaining folds as training set. A more robust approach is the **K-flod cross-validation** that we used in the module 2 for land cover classification. We encourage readers to test this approach and compare results with those from a single model training.

```{r}
testing  <- points_climate[fold == 1, ]
training <- points_climate[fold != 1, ]
```


## Model building

Now, it is time to build our SDM. Several SDM approaches are available to handle presence-absence or presence-background data including generalized linear models (GLMs) and its variants, Maxent, tree-based methods (e.g. Random Forest). 

In this study, we use the generalized linear model which is also known as binary logistic regression model, a popular approach used in machine learning. The column `pa` is the response variable while "." indicates to the `glm()` that all the the remaining columns should be considered as covariates in the model (i.e. bio1, bio4, bio12 and landcover).

```{r}
# Build a model using training data
glm_model <- glm(pa ~ ., data = training, family = binomial())
```

After building the model, we can now view the results and look at the significance of covariates.
```{r}
anova(glm_model)
```

The ANOVA table from the model show that the temperature seasonalty and land cover variables have a significant effect on the probability of presence of *B. bipinnata*. The result aligns with those we obtained from the analyses carried out in the Module 2 on land cover classification where we notice a significant variation of the amount of introduced species among land cover. 

After we have built our model, we can use it to predict the habitat suitability across the entire Fogo map. 

```{r}
# Get predicted values from the model
glm_predict <- predict(bioclim_kept, glm_model, type = "response")

# Print predicted values
plot(glm_predict, main = "Probability of occurrence of Bidens bipinnata")
```

We can also predict the species distribution in the future using future climatic data. For more details see Oliver (2024).


## Model evaluation

We now take that model, and evaluate it using the observation data and the pseudo-absence points we reserved for model testing. We then use this test to establish a cutoff of occurrence probability to determine the boundaries of the *B. bipinnata* range. In the following code, `p` argument stands for presence data while `a`stands for absence/background data in the `pa_evaluate()` function.


```{r}
# Use testing data for model evaluation
glm_eval <- pa_evaluate(p = testing[testing$pa == 1, ],
                        a = testing[testing$pa == 0, ],
                        model = glm_model,
                        type = "response")
```


We determine a minimum threshold as the cutoff for converting the habitat suitability map predicted by the model into presence and absence.

```{r}
# Determine minimum threshold for "presence"
glm_threshold <- glm_eval@thresholds$max_spec_sens
```

Finally, we can use that threshold to paint a map with sites predicted to be suitable for *Bidens bipinnata* in the Fogo Island. Raster cells with 0 are set to NA while those with 1 are colored on the final map. 

```{r}
# Plot base map
plot(map_fogo, 
     axes = TRUE, 
     col = "grey95",
     main = "Habitat suitability for Bidens bipinnata")

# Only plot areas where probability of occurrence is greater than the threshold
plot(glm_predict > glm_threshold, # this generates a raster with 0 and 1
     add = TRUE, 
     legend = FALSE, 
     col = c(NA, "olivedrab")) # we provide different colors: 0 (NA) and 1 ("olivedrab"):

# And add those observations
points(x = geom(obs_points)[,"x"], 
       y = geom(obs_points)[,"y"], 
       col = "black",
       pch = "+", 
       cex = 0.75)

# Redraw the Fogo Island borders
plot(map_fogo, add = TRUE, border = "grey5")
```


## Conclusion and perspectives

This tutorial presented a step-by-step workflow for building and evaluating Species Distribution Model in R using *Bidens bipinnata* species as a case study. It implemented the generalized linear model (GLM) to predict the probability of species occurrence in the Fogo Island. The tutorial used environmental data with different resolutions and projection systems to show learners how to handle such complexity within spatial data used for building SDM.

However, other algorithms including Generalized Additive Models (GAMs), Maximum Entropy (Maxent) and tree-based approaches are well known in the literature to implement SDMs using background points as absence data. We encourage readers to test different algorithms and select the best one based on performance metrics like the area under the ROC curve (AUC), accuracy, precision, etc.

Recent developments on SDMs suggested to model a species distribution as an **Inhomogeneous Poisson Process (IPP)** which is implemented in the recent version of Maxent software. Technical aspects of this modeling framework is beyond the scope of this tutorial and we recommend the learners to read the paper of [Phillips et al. (2017)](https://onlinelibrary.wiley.com/doi/10.1111/ecog.03049) and references therein to have an idea about the IPP framework. 


## References

Phillips, S.J., Anderson, R.P., Dudík, M., Schapire, R.E., Blair, M.E., 2017. Opening the black box: an open‐source release of Maxent. Ecography 40, 887–893.<https://doi.org/10.1111/ecog.03049>.

Oliver, J., 2024. learn-r - A very brief introduction to species distribution models in R [WWW Document]. URL <https://jcoliver.github.io/learn-r/011-species-distribution-models.html9> (accessed 9.25.24).
